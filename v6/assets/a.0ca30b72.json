{"title":"Claim based Authorization","categories":["cookbook"],"order":16,"meta":{"keywords":null,"description":null},"content":"<h2 id=\"the-issue\"><a name=\"the-issue\" class=\"h-link\" href=\"#\"></a>The issue</h2>\n<p>You need to implement simple authorization (i.e., permission management) logic based on claims (or actions). In other words, you have action (or a claim) but don't have the concept of &quot;subject&quot; on which this action can be applied (or it's not important in your app). This concept is very similar to <a href=\"https://en.wikipedia.org/wiki/Claims-based_identity\" target=\"_blank\" rel=\"noopener nofollow\">claim based identity</a>.</p>\n<p>The easiest way to achieve this is to create an array of all possible actions (or claims) and check if a claim exists on the user object:</p>\n<pre><code class=\"hljs language-ts\"><span class=\"hljs-keyword\">const</span> ACTIONS = [<span class=\"hljs-string\">&#x27;review&#x27;</span>, <span class=\"hljs-string\">&#x27;publish&#x27;</span>, <span class=\"hljs-string\">&#x27;read&#x27;</span>];\n\n<span class=\"hljs-function\"><span class=\"hljs-keyword\">function</span> <span class=\"hljs-title\">publishArticle</span>(<span class=\"hljs-params\">article, user</span>) </span>{\n  <span class=\"hljs-keyword\">if</span> (!user.permissions.includes(<span class=\"hljs-string\">&#x27;publish&#x27;</span>)) {\n    <span class=\"hljs-keyword\">throw</span> <span class=\"hljs-keyword\">new</span> <span class=\"hljs-built_in\">Error</span>(<span class=\"hljs-string\">&#x27;You cannot publish articles&#x27;</span>);\n  }\n\n  <span class=\"hljs-comment\">// logic to publish article</span>\n}\n</code></pre>\n<p>What are <strong>the disadvantages</strong> of handmade solution:</p>\n<ol>\n<li>You need to test.<br>\nIt's very important to know that your permissions logic is reliable otherwise it doesn't make sense.</li>\n<li>You need to support it (i.e., fix bugs).<br>\nIf you find a bug, you need to fix it and add tests. But what would you do if the bug is found by the attacker?</li>\n<li>You need to evolve it.<br>\nThe world constantly changes, the same way your business requirements changes. If you need to add more complex permissions logic (e.g., permission per subject or per attribute), you will need to implement and test it yourself.</li>\n</ol>\n<p>All that consumes time and resources, as a result postpones the delivery of your product.</p>\n<h2 id=\"the-solution\"><a name=\"the-solution\" class=\"h-link\" href=\"#\"></a>The solution</h2>\n<p>Fortunately, CASL supports claim based authorization. The example above can be represented in CASL:</p>\n<pre><code class=\"hljs language-ts\"><span class=\"hljs-keyword\">import</span> { AbilityBuilder, PureAbility } <span class=\"hljs-keyword\">from</span> <span class=\"hljs-string\">&#x27;@casl/ability&#x27;</span>;\n\n<span class=\"hljs-keyword\">type</span> AppAbility = PureAbility&lt;Actions&gt;;\n<span class=\"hljs-keyword\">type</span> Actions = <span class=\"hljs-string\">&#x27;review&#x27;</span> | <span class=\"hljs-string\">&#x27;publish&#x27;</span> | <span class=\"hljs-string\">&#x27;read&#x27;</span>;\n\n<span class=\"hljs-keyword\">const</span> { can, build } = <span class=\"hljs-keyword\">new</span> AbilityBuilder&lt;AppAbility&gt;(PureAbility);\ncan(<span class=\"hljs-string\">&#x27;review&#x27;</span>);\ncan(<span class=\"hljs-string\">&#x27;publish&#x27;</span>);\ncan(<span class=\"hljs-string\">&#x27;read&#x27;</span>);\n\n<span class=\"hljs-keyword\">const</span> ability = build();\n\n<span class=\"hljs-function\"><span class=\"hljs-keyword\">function</span> <span class=\"hljs-title\">publishArticle</span>(<span class=\"hljs-params\">article: <span class=\"hljs-built_in\">object</span>, ability: AppAbility</span>) </span>{\n  <span class=\"hljs-keyword\">if</span> (ability.cannot(<span class=\"hljs-string\">&#x27;publish&#x27;</span>)) {\n    <span class=\"hljs-keyword\">throw</span> <span class=\"hljs-keyword\">new</span> <span class=\"hljs-built_in\">Error</span>(<span class=\"hljs-string\">&#x27;You cannot publish articles&#x27;</span>);\n  }\n\n  <span class=\"hljs-comment\">// logic to publish article</span>\n}\n</code></pre>\n<p><strong>The advantages</strong> of this:</p>\n<ol>\n<li>You can start with simple permissions logic and evolve it together with your business requirements.</li>\n<li>Thanks to tree-shaking in <a href=\"https://rollupjs.org/guide/en/\" target=\"_blank\" rel=\"noopener nofollow\">rollup</a> and <a href=\"https://webpack.js.org/\" target=\"_blank\" rel=\"noopener nofollow\">webpack</a> CASL takes only 1.5KB for claim based authorization.</li>\n<li>No need to support own solution. Lots of people use and create issues for OpenSource libraries like CASL, so you get support, bug fix and new features for free.</li>\n</ol>\n<h2 id=\"when-to-avoid\"><a name=\"when-to-avoid\" class=\"h-link\" href=\"#\"></a>When To Avoid</h2>\n<p>Sometimes applications use merged action and subject as a claim: <code>create_article</code>, <code>read_article</code>, <code>read_user</code>. In such cases, it'd better separate actions and subjects. This will allow you to add conditions and fields to your abilities later without refactoring the whole application.</p>","headings":[{"id":"the-issue","title":"The issue"},{"id":"the-solution","title":"The solution"},{"id":"when-to-avoid","title":"When To Avoid"}],"id":"cookbook/claim-authorization"}